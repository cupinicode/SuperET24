<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Caja de Autogestión</title>
<HTA:APPLICATION
  ID="CajaSuper"
  APPLICATIONNAME="CajaSuper"
  BORDER="thin"
  BORDERSTYLE="normal"
  CAPTION="yes"
  SHOWINTASKBAR="yes"
  SINGLEINSTANCE="yes"
  SYSMENU="yes"
  WINDOWSTATE="normal"
  SCROLL="no"
/>
<style>
body {
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:url('super.png') no-repeat center center fixed;
    background-size:cover;
    color:#333;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:2rem;
}
h1 {
    color:#fff;
    text-shadow:1px 1px 2px #000;
}
input[type="text"] {
    position:absolute;
    left:-9999px;
}
.products {
    display:flex;
    flex-wrap:wrap;
    gap:1rem;
    justify-content:center;
    margin-top:1rem;
}
.product-card {
    position:relative;
    background:rgba(255,255,255,0.9);
    border-radius:15px;
    box-shadow:0 4px 8px rgba(0,0,0,0.1);
    padding:0.5rem;
    width:200px;
    height:300px;
    text-align:center;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    transition:transform 0.3s ease;
}
.glow {
    animation: glowUp 0.4s ease;
}
@keyframes glowUp {
    0% {transform:scale(1);box-shadow:0 0 0px #00ff00;}
    50% {transform:scale(1.3);box-shadow:0 0 25px #00ff00,0 0 40px #00ff00;}
    100% {transform:scale(1);box-shadow:0 0 0px #00ff00;}
}
.product-card img { width:100%; height:130px; object-fit:contain;}
.product-card h4 { font-size:0.9rem; margin:0.3rem 0; overflow:hidden;}
.product-card p { margin:0; font-weight:bold;}
.remove-btn {
    position:absolute;
    top:8px;
    right:8px;
    background:red;
    color:white;
    border:none;
    border-radius:6px;
    padding:4px 8px;
    cursor:pointer;
    font-weight:bold;
}
.total {
    margin-top:2rem;
    font-size:1.5rem;
    font-weight:bold;
    background:rgba(255,255,255,0.8);
    padding:0.5rem 1rem;
    border-radius:10px;
}
button.finalizar {
    padding:0.75rem 2rem;
    font-size:1.2rem;
    border:none;
    border-radius:10px;
    background-color:#28a745;
    color:white;
    cursor:pointer;
    margin-top:1rem;
    transition:background 0.3s;
}
button.finalizar:hover:not(:disabled){ background-color:#218838;}
button.finalizar:disabled{ background-color:#aaa; cursor:not-allowed;}
</style>
</head>
<body>
<h1>Caja de Autogestión</h1>
<input type="text" id="inputCodigo" autofocus>
<div class="products" id="productList"></div>
<div class="total" id="total">Total: $0.00</div>
<button class="finalizar" id="btnFinalizar" onclick="finalizarCompra()" disabled>Finalizar compra</button>

<script>
var productos=[
    {id:1,nombre:"Leche Entera La Serenisima 1 litro",precio:2110.99,foto:"leche.png",codigo_barras:"7790742335500"},
    {id:2,nombre:"Margarina Danica Dorada Cremosa",precio:2179.50,foto:"danica.png",codigo_barras:"7791620187778"},
    {id:3,nombre:"Arroz con Leche y Dulce de Leche",precio:12000.00,foto:"arrozconlecheddl.jpg",codigo_barras:"7793913013467"},
    {id:4,nombre:"Arroz con Leche Descremada",precio:12000.00,foto:"arrozconlechedes.jpg",codigo_barras:"7793913000504"},
    {id:5,nombre:"Pasta Dental Kolynos Super Blanco 70g",precio:2490.00,foto:"kolynos.jpg",codigo_barras:"7509546686486"},
    {id:6,nombre:"Lampara LED LedVance 9W Fria",precio:1120.00,foto:"lampara.jpg",codigo_barras:"4058075776517"}
];

var input=document.getElementById('inputCodigo');
var productList=document.getElementById('productList');
var totalDiv=document.getElementById('total');
var btnFinalizar=document.getElementById('btnFinalizar');
var carrito=[];

input.addEventListener('keypress',function(e){
    if(e.key==='Enter'){
        var codigo=input.value.trim();
        var producto=productos.find(function(p){return p.id.toString()===codigo||p.codigo_barras===codigo;});
        if(producto){ agregarProducto(producto);}
        else{ alert("Producto no encontrado"); }
        input.value='';
    }
});

function agregarProducto(producto){
    if(!carrito.find(function(p){return p.id===producto.id;}) && carrito.length>=5){
        alert("Máximo 5 productos diferentes."); return;
    }
    var existente=carrito.find(function(p){return p.id===producto.id;});
    if(existente){
        if(existente.cantidad>=5){ alert("Máximo 5 unidades por producto."); return; }
        existente.cantidad++;
        animarProducto(existente.id);
    }else{
        carrito.push({id:producto.id,nombre:producto.nombre,precio:producto.precio,foto:producto.foto,cantidad:1});
        animarProducto(producto.id);
    }
    actualizarVista();
}

function animarProducto(id){
    setTimeout(function(){
        var card=document.querySelector('.product-card[data-id="'+id+'"]');
        if(card){ card.classList.add('glow'); setTimeout(function(){ card.classList.remove('glow');},400);}
    },50);
}

function eliminarProducto(id){
    carrito=carrito.filter(function(p){return p.id!==id;});
    actualizarVista();
    input.focus();
}

function calcularTotal(){
    var total=0;
    for(var i=0;i<carrito.length;i++){ total+=carrito[i].precio*carrito[i].cantidad; }
    return total;
}

function actualizarEstadoBoton(){ btnFinalizar.disabled=(carrito.length===0); }

function actualizarVista(){
    productList.innerHTML='';
    for(var i=0;i<carrito.length;i++){
        var p=carrito[i];
        var card=document.createElement('div');
        card.className='product-card';
        card.setAttribute('data-id',p.id);
        card.innerHTML='<button class="remove-btn" onclick="eliminarProducto('+p.id+')">Eliminar</button>'+
                       '<img src="'+p.foto+'" alt="'+p.nombre+'"/>'+
                       '<h4>'+p.nombre+'</h4>'+
                       '<span>Cantidad: '+p.cantidad+'</span>'+
                       '<p>Precio unitario: $'+p.precio.toFixed(2)+'</p>';
        productList.appendChild(card);
    }
    totalDiv.textContent="Total: $"+calcularTotal().toFixed(2);
    actualizarEstadoBoton();
    input.focus();
}

function finalizarCompra(){
    if(carrito.length===0) return;
    var cuerpo="", total=0, cantidadTotal=0;
    for(var i=0;i<carrito.length;i++){
        var p=carrito[i];
        var subtotal=p.precio*p.cantidad;
        total+=subtotal; cantidadTotal+=p.cantidad;
        cuerpo+=padLeft(p.cantidad,2)+" x "+padRight(p.nombre,20)+" $"+padLeft(subtotal.toFixed(2),7)+"\n";
    }
    var fecha=new Date();
    var fechaStr=fecha.toLocaleDateString();
    var horaStr=fecha.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    var ticket="******************************\n"+
               "         SuperET24\n"+
               "  (Doc. no válido como factura)\n"+
               " Fecha: "+fechaStr+" - Hora: "+horaStr+"\n"+
               "------------------------------\n"+
               cuerpo+
               "------------------------------\n"+
               "Items: "+padRight(cantidadTotal,3)+"         Total: $"+total.toFixed(2)+"\n"+
               "------------------------------\n"+
               "Muchas gracias por visitar\n"+
               "ExpoTécnica - Escuela Técnica N°24\n"+
               "******************************\n";
    imprimirTicketHTA(ticket);
    carrito=[]; actualizarVista();
    alert("Compra finalizada");
}

function imprimirTicketHTA(texto){
    try{
        var shell=new ActiveXObject("WScript.Shell");
        var comando='ImprimirTicket.exe "'+texto.replace(/"/g,'\\"')+'"';
        shell.Run(comando,1,true);
    }catch(e){ alert("Error al imprimir: "+e.message); }
}

function padLeft(text,length){ text=text.toString(); while(text.length<length) text=" "+text; return text; }
function padRight(text,length){ text=text.toString(); while(text.length<length) text=text+" "; return text; }
</script>
</body>
</html>
