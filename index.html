<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Agregar SweetAlert en el <head> -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  <title>Caja de Supermercado</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url('super.png') no-repeat center center fixed;
      background-size: cover;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 9rem 2rem 2rem 2rem;
    }

    h1 {
      color: #fff;
      text-shadow: 1px 1px 2px #000;
    }

    /* Input invisible para el escáner */
    input[type="text"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .products {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .product-card {
      position: relative;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 0.5rem;
      width: 200px;
      height: 300px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.3s ease;
    }

    /* Glow más intenso */
    .glow {
      animation: glowUp 0.4s ease;
    }

    @keyframes glowUp {
      0% { transform: scale(1); box-shadow: 0 0 0px #00ff00; }
      50% { transform: scale(1.30); box-shadow: 0 0 25px #00ff00, 0 0 40px #00ff00; }
      100% { transform: scale(1); box-shadow: 0 0 0px #00ff00; }
    }

    .product-card img {
      width: 100%;
      height: 130px;
      object-fit: contain;
    }

    .product-card h4 {
      font-size: 0.9rem;
      margin: 0.3rem 0;
      overflow: hidden;
    }

    .product-card p {
      margin: 0;
      font-weight: bold;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: red;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .total {
      margin-top: 2rem;
      font-size: 1.5rem;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.8);
      padding: 0.5rem 1rem;
      border-radius: 10px;
    }

    button.finalizar {
      padding: 0.75rem 2rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 10px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.3s;
    }

    button.finalizar:hover:not(:disabled) {
      background-color: #218838;
    }

    button.finalizar:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <br><br><br>
  <h1>Caja de Autocobro</h1>
  <input type="text" id="inputCodigo" autofocus />

  <div class="products" id="productList"></div>
  <div class="total" id="total">Total: $0.00</div>
  <button class="finalizar" id="btnFinalizar" onclick="finalizarCompra()" disabled>Finalizar compra</button>

  <script>
    const productos = [
      { id: 1,  nombre: "Leche Entera La Serenisima 1 litro", precio: 2110.99, foto: "leche.png", codigo_barras: "7790742335500" },
      { id: 2,  nombre: "Margarina Danica Dorada Cremosa", precio: 2179.50, foto: "danica.png", codigo_barras: "7791620187778" },
      { id: 3,  nombre: "Arroz con Leche y Dulce de Leche", precio: 12000.00, foto: "arrozconlecheddl.jpg", codigo_barras: "7793913013467" },
      { id: 4,  nombre: "Arroz con Leche Descremada", precio: 12000.00, foto: "arrozconlechedes.jpg", codigo_barras: "7793913000504" },
      { id: 5,  nombre: "Pasta Dental Kolynos Super Blanco 70g", precio: 2490.00, foto: "kolynos.jpg", codigo_barras: "7509546686486" },
      { id: 6,  nombre: "Pasta Dental Kolynos Super Blanco 70g", precio: 2490.00, foto: "kolynos.jpg", codigo_barras: "7509546692234" },
      { id: 7,  nombre: "Lampara LED LedVance 9W Fria", precio: 1120.00, foto: "lampara.jpg", codigo_barras: "4058075776517" },
      { id: 8,  nombre: "Queso Untable Tonadita Jamon", precio: 2115.00, foto: "quesojamon.jpg", codigo_barras: "7798060852990" },
      { id: 9,  nombre: "Jugo Naranja Cepita Del Valle 1 litro", precio: 2140.00, foto: "cepita.jpg", codigo_barras: "7790895648267" },
      { id: 10, nombre: "Barra Pop Crocante 15g", precio: 440.00, foto: "barrapop.jpg", codigo_barras: "7798397380081" },
      { id: 11, nombre: "Barra de Cereal Cereanola", precio: 450.00, foto: "barracereal.jpg", codigo_barras: "7798124098128" }
    ];

    const input = document.getElementById('inputCodigo');
    const productList = document.getElementById('productList');
    const totalDiv = document.getElementById('total');
    const btnFinalizar = document.getElementById('btnFinalizar');
    let carrito = [];

    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        const codigo = input.value.trim();
        const producto = productos.find(p => p.id.toString() === codigo || p.codigo_barras === codigo);
        if (producto) {
          agregarProducto(producto);
        } else {
            Swal.fire({
            icon: 'warning',
            title: 'Producto no encontrado',
            confirmButtonText: 'OK'
            });
        }
        input.value = '';
      }
    });

    
function agregarProducto(producto) {
  if (!carrito.find(p => p.id === producto.id) && carrito.length >= 5) {
    Swal.fire({
      icon: 'warning',
      title: 'Máximo 5 productos diferentes',
      confirmButtonText: 'Entendido'
    });
    return;
  }
  const existente = carrito.find(p => p.id === producto.id);
  if (existente) {
    if (existente.cantidad >= 5) {
      Swal.fire({
        icon: 'warning',
        title: 'Máximo 5 unidades por producto',
        confirmButtonText: 'OK'
      });
      return;
    }
    existente.cantidad++;
    animarProducto(existente.id);
  } else {
    carrito.push({ ...producto, cantidad: 1 });
    animarProducto(producto.id);
  }
  actualizarVista();
}

    function animarProducto(id) {
      setTimeout(() => {
        const card = document.querySelector(`.product-card[data-id="${id}"]`);
        if (card) {
          card.classList.add('glow');
          setTimeout(() => card.classList.remove('glow'), 400);
        }
      }, 50);
    }

    function eliminarProducto(id) {
      carrito = carrito.filter(p => p.id !== id);
      actualizarVista();
      input.focus();
    }

    function calcularTotal() {
      return carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
    }

    function actualizarEstadoBoton() {
      btnFinalizar.disabled = carrito.length === 0;
    }

    function actualizarVista() {
      productList.innerHTML = '';
      carrito.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.setAttribute('data-id', p.id);

        card.innerHTML = `
          <button class="remove-btn" onclick="eliminarProducto(${p.id})">Eliminar</button>
          <img src="${p.foto}" alt="${p.nombre}" />
          <h4>${p.nombre}</h4>
          <span>Cantidad: ${p.cantidad}</span>
          <p>Precio unitario: $${p.precio.toFixed(2)}</p>
        `;
        productList.appendChild(card);
      });

      totalDiv.textContent = `Total: $${calcularTotal().toFixed(2)}`;
      actualizarEstadoBoton();
      input.focus();
    }

    function finalizarCompra() {
      if (carrito.length === 0) return;

      const ticket = carrito.map(p => `${p.nombre} x${p.cantidad} - $${(p.precio * p.cantidad).toFixed(2)}`).join('\n');
      const mensaje = `${ticket}\n\nTOTAL: $${calcularTotal().toFixed(2)}`;
      imprimirTicket(mensaje);
      // alert("Compra finalizada");
      carrito = [];
      actualizarVista();
      input.focus();
    }

function imprimirTicket(texto) {
  const lineas = texto.split('\n').filter(line => line.trim() !== '');

   const fecha = new Date();
  const fechaStr = fecha.toLocaleDateString();
  const horaStr = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  let total = 0;
  let cantidadTotal = 0;
  let cuerpo = "";

  lineas.forEach(linea => {
    const match = linea.match(/^(.*) x(\d+) - \$([\d.,]+)/);
    if (match) {
      const nombre = match[1].trim().slice(0, 20).padEnd(20, ' ');
      const cantidad = parseInt(match[2]);
      const precio = parseFloat(match[3].replace(',', '.'));
      const subtotal = cantidad * precio;
      total += subtotal;
      cantidadTotal += cantidad;

      const lineaFormateada = `${cantidad.toString().padStart(2, ' ')} x ${nombre} $${subtotal.toFixed(2).padStart(7, ' ')}`;
      cuerpo += `${lineaFormateada}\n`;
    }
  });

  const ticket = `
====================================

   ESCUELA TECNICA N° 24 D.E. 17

     "Defensa de Buenos Aires"
        Cuenca 3246 -- CABA
         Tel: 11 4501-9251

               [ X ]

 (Documento no valido como factura)

====================================

  ===   S u p e r E T   2 4   ===

====================================

 Fecha: ${fechaStr}  -  Hora: ${horaStr}

------------------------------------
     - Detalle de su compra -

${cuerpo}
------------------------------------

Items: ${cantidadTotal.toString().padEnd(3)}         Total: $${total.toFixed(2)}

------------------------------------

   Ciclo Superior de Computación
Sistema de Gestión de Caja Autocobro
        para supermercados
   Proyecto Desarrollado por los
   alumnos de 6to 6ta Comp. para
  "Prácticas  Profesionalizantes"

====================================

     Muchas gracias por visitar

 "E x p o T é c n i c a   2 0 2 5"
        
    SEDE :  Escuela Técnica N°24

    https://et24de17-caba.edu.ar/
    mail : det_24_de17@bue.edu.ar

************************************
`;

  const win = window.open('', '', 'width=400,height=600');
  win.document.write(`<pre>${ticket}</pre>`);
  win.document.close();
  win.focus();
  win.print();
  win.close();
}


""

/*     function imprimirTicket(texto) {
      const win = window.open('', '', 'width=400,height=600');
      win.document.write(`<pre>************ SuperET24 ***********</pre>`);
      win.document.write(`<pre>**********************************</pre>`);
      win.document.write(`<pre>(documento no válido como factura)</pre>`);
      win.document.write(`<pre> </pre>`);
      win.document.write(`<pre>${texto}</pre>`);
      win.document.write(`<pre> </pre>`);
      win.document.write(`<pre>Muchas gracias por visitar ExpoTécnica</pre>`);
      win.document.write(`<pre>   Escuela Técnica Nro. 24</pre>`);
      win.document.write(`<pre>**********************************</pre>`);
      win.document.close();
      win.focus();
      win.print();
      win.close();
    }
 */  </script>
</body>
</html>
